# Tests for database connection string generation with secret references
suite: Database Connection String Tests
templates:
  - config-secret.yaml
tests:
  - it: should use secret references for embedded postgres
    set:
      postgres.enabled: true
      registry.enabled: true
    asserts:
      - isKind:
          of: Secret
      # Database names default to <namespace>_main and <namespace>_audit
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'db_connection = ''postgres://\{\{secret ".*" "username" \| pathEscape\}\}:\{\{secret ".*" "password" \| pathEscape\}\}@.*:5432/.*_main\?sslmode=disable'''
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'audit_db_connection = ''postgres://\{\{secret ".*" "username" \| pathEscape\}\}:\{\{secret ".*" "password" \| pathEscape\}\}@.*:5432/.*_audit\?sslmode=disable'''

  - it: should reference correct secret name for embedded postgres
    set:
      postgres.enabled: true
      registry.enabled: true
    asserts:
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'secret ".*-db-app" "username" \| pathEscape'
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'secret ".*-db-app" "password" \| pathEscape'

  - it: should use custom secret keys for embedded postgres
    set:
      postgres.enabled: true
      postgres.appUser.usernameKey: user
      postgres.appUser.passwordKey: pass
      registry.enabled: true
    asserts:
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'secret ".*-db-app" "user" \| pathEscape'
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'secret ".*-db-app" "pass" \| pathEscape'

  - it: should use existingSecretName for external database
    set:
      postgres.enabled: false
      externalDatabase.enabled: true
      externalDatabase.host: mydb.example.com
      externalDatabase.existingSecretName: my-terraform-secret
      externalDatabase.usernameKey: db_user
      externalDatabase.passwordKey: db_pass
      registry.enabled: true
    asserts:
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'secret "my-terraform-secret" "db_user" \| pathEscape'
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'secret "my-terraform-secret" "db_pass" \| pathEscape'
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: '@mydb.example.com:5432/'

  - it: should create secret and reference it for external database with password in values
    set:
      postgres.enabled: false
      externalDatabase.enabled: true
      externalDatabase.host: mydb.example.com
      externalDatabase.username: myuser
      externalDatabase.password: mypassword
      registry.enabled: true
    asserts:
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'secret ".*-external-db" "username" \| pathEscape'
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'secret ".*-external-db" "password" \| pathEscape'

  - it: should use custom database names
    set:
      postgres.enabled: true
      config.metadata.database: customdb
      config.metadata.auditDatabase: customaudit
      registry.enabled: true
    asserts:
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: '/customdb\?sslmode='
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: '/customaudit\?sslmode='

  - it: should use custom sslmode for embedded postgres
    set:
      postgres.enabled: true
      config.metadata.sslMode: require
      registry.enabled: true
    asserts:
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'sslmode=require'

  - it: should use sslmode for external database
    set:
      postgres.enabled: false
      externalDatabase.enabled: true
      externalDatabase.host: mydb.example.com
      externalDatabase.existingSecretName: my-secret
      externalDatabase.sslMode: verify-full
      registry.enabled: true
    asserts:
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'sslmode=verify-full'

  - it: should use custom parameters for external database
    set:
      postgres.enabled: false
      externalDatabase.enabled: true
      externalDatabase.host: mydb.example.com
      externalDatabase.existingSecretName: my-secret
      externalDatabase.parameters: "sslmode=require&connect_timeout=10"
      registry.enabled: true
    asserts:
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'sslmode=require&connect_timeout=10'

  # Tests for namespace-based database names with bundled PostgreSQL
  - it: should use namespace-based database names for embedded postgres
    release:
      namespace: myapp
    set:
      postgres.enabled: true
      registry.enabled: true
    asserts:
      # Main database
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'db_connection = ''postgres://.*@.*:5432/myapp_main\?'
      # Audit database
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'audit_db_connection = ''postgres://.*@.*:5432/myapp_audit\?'
      # App store plugin database
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: '\[plugin\."store\.in"\]'
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'db_connection = ''postgres://.*@.*:5432/myapp_app_store\?'
      # FS plugin database
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: '\[plugin\."fs\.in"\]'
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'db_connection = ''postgres://.*@.*:5432/myapp_fs\?'

  # Tests for namespace-based database names with Terraform/external database
  - it: should use namespace-based database names for external database (Terraform)
    release:
      namespace: prod
    set:
      postgres.enabled: false
      externalDatabase.enabled: true
      externalDatabase.host: terraform-rds.example.com
      externalDatabase.existingSecretName: terraform-db-credentials
      registry.enabled: true
    asserts:
      # Main database
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'db_connection = ''postgres://.*@terraform-rds\.example\.com:5432/prod_main\?'
      # Audit database
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'audit_db_connection = ''postgres://.*@terraform-rds\.example\.com:5432/prod_audit\?'
      # App store plugin database
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: '\[plugin\."store\.in"\]'
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'db_connection = ''postgres://.*@terraform-rds\.example\.com:5432/prod_app_store\?'
      # FS plugin database
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: '\[plugin\."fs\.in"\]'
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: 'db_connection = ''postgres://.*@terraform-rds\.example\.com:5432/prod_fs\?'

  - it: should use custom database names for all databases
    set:
      postgres.enabled: true
      config.metadata.database: custom_main
      config.metadata.auditDatabase: custom_audit
      config.metadata.appStoreDatabase: custom_store
      config.metadata.fsDatabase: custom_fs
      registry.enabled: true
    asserts:
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: '/custom_main\?sslmode='
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: '/custom_audit\?sslmode='
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: '/custom_store\?sslmode='
      - matchRegex:
          path: stringData["openrun.toml"]
          pattern: '/custom_fs\?sslmode='
