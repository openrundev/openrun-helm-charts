# Tests for postgres secrets creation
suite: Postgres Secrets Tests
templates:
  - postgres-secrets.yaml
tests:
  - it: should create app user secret when postgres enabled
    set:
      postgres.enabled: true
    asserts:
      - hasDocuments:
          count: 2
      - isKind:
          of: Secret
        documentIndex: 0
      - equal:
          path: type
          value: kubernetes.io/basic-auth
        documentIndex: 0
      - matchRegex:
          path: metadata.name
          pattern: '.*-db-app$'
        documentIndex: 0

  - it: should create superuser secret when postgres enabled
    set:
      postgres.enabled: true
    asserts:
      - isKind:
          of: Secret
        documentIndex: 1
      - matchRegex:
          path: metadata.name
          pattern: '.*-db-superuser$'
        documentIndex: 1

  - it: should use custom credentials for app user
    set:
      postgres.enabled: true
      postgres.appUser.username: customuser
      postgres.appUser.password: custompass
    asserts:
      - equal:
          path: stringData.username
          value: customuser
        documentIndex: 0
      - equal:
          path: stringData.password
          value: custompass
        documentIndex: 0

  - it: should use custom key names for app user
    set:
      postgres.enabled: true
      postgres.appUser.usernameKey: user
      postgres.appUser.passwordKey: pass
      postgres.appUser.username: myuser
      postgres.appUser.password: mypass
    asserts:
      - equal:
          path: stringData.user
          value: myuser
        documentIndex: 0
      - equal:
          path: stringData.pass
          value: mypass
        documentIndex: 0

  - it: should not create app user secret when existingSecretName is set
    set:
      postgres.enabled: true
      postgres.appUser.existingSecretName: my-existing-secret
    asserts:
      - hasDocuments:
          count: 1
      - matchRegex:
          path: metadata.name
          pattern: '.*-db-superuser$'
        documentIndex: 0

  - it: should not create superuser secret when existingSecretName is set
    set:
      postgres.enabled: true
      postgres.superuser.existingSecretName: my-existing-superuser
    asserts:
      - hasDocuments:
          count: 1
      - matchRegex:
          path: metadata.name
          pattern: '.*-db-app$'
        documentIndex: 0

  - it: should not create any secrets when both existingSecretNames are set
    set:
      postgres.enabled: true
      postgres.appUser.existingSecretName: my-app-secret
      postgres.superuser.existingSecretName: my-superuser-secret
    asserts:
      - hasDocuments:
          count: 0

  - it: should create external database secret when password in values
    set:
      postgres.enabled: false
      externalDatabase.enabled: true
      externalDatabase.host: mydb.example.com
      externalDatabase.username: extuser
      externalDatabase.password: extpass
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - matchRegex:
          path: metadata.name
          pattern: '.*-external-db$'
      - equal:
          path: stringData.username
          value: extuser
      - equal:
          path: stringData.password
          value: extpass

  - it: should not create external database secret when existingSecretName is set
    set:
      postgres.enabled: false
      externalDatabase.enabled: true
      externalDatabase.host: mydb.example.com
      externalDatabase.existingSecretName: my-terraform-secret
    asserts:
      - hasDocuments:
          count: 0

  - it: should use custom key names for external database
    set:
      postgres.enabled: false
      externalDatabase.enabled: true
      externalDatabase.host: mydb.example.com
      externalDatabase.username: myuser
      externalDatabase.password: mypass
      externalDatabase.usernameKey: db_user
      externalDatabase.passwordKey: db_pass
    asserts:
      - equal:
          path: stringData.db_user
          value: myuser
      - equal:
          path: stringData.db_pass
          value: mypass
