{{- $fullname := include "openrun.fullname" . -}}
{{- $config := tpl (.Files.Get "files/openrun.toml.tmpl") . -}}
{{- $configFile := "/var/lib/openrun/openrun.toml" -}}
{{- $healthCheckPath := "/_openrun/health" -}}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ $fullname }}
  labels:
    {{- include "openrun.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      {{- include "openrun.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "openrun.selectorLabels" . | nindent 8 }}
      annotations:
        checksum/openrun-config: {{ $config | sha256sum | quote }}
    spec:
      serviceAccountName: {{ include "openrun.serviceAccountName" . }}
      initContainers:
        - name: wait-for-db
          image: "{{ .Values.postgres.image.repository }}:{{ .Values.postgres.image.tag }}"
          imagePullPolicy: {{ .Values.postgres.image.pullPolicy }}
          command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail
              TIMEOUT=600
              ELAPSED=0
              INTERVAL=2
              AUDIT_DB="${POSTGRES_AUDIT_DB:-}"
              AUDIT_DB_ESCAPED=""
              if [ -n "$AUDIT_DB" ]; then
                AUDIT_DB_ESCAPED=$(printf "%s" "$AUDIT_DB" | sed "s/'/''/g")
              fi
              echo "Waiting for database to be ready (timeout: ${TIMEOUT}s)..."
              until PGPASSWORD="$POSTGRES_PASSWORD" psql -h "$POSTGRES_HOST" -p "$POSTGRES_PORT" \
                -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c "SELECT 1" >/dev/null 2>&1 && \
                { [ -z "$AUDIT_DB" ] || PGPASSWORD="$POSTGRES_PASSWORD" psql -h "$POSTGRES_HOST" -p "$POSTGRES_PORT" \
                  -U "$POSTGRES_USER" -d "$POSTGRES_DB" -tAc "SELECT 1 FROM pg_database WHERE datname='${AUDIT_DB_ESCAPED}'" | grep -q 1; }; do
                if [ $ELAPSED -ge $TIMEOUT ]; then
                  echo "ERROR: Timed out after ${TIMEOUT}s waiting for database"
                  exit 1
                fi
                echo "Database not ready, waiting... (${ELAPSED}s elapsed)"
                sleep $INTERVAL
                ELAPSED=$((ELAPSED + INTERVAL))
              done
              echo "Database is ready after ${ELAPSED}s"
          env:
            {{- if .Values.postgres.enabled }}
            - name: POSTGRES_HOST
              value: {{ include "openrun.postgresClusterName" . }}
            - name: POSTGRES_PORT
              value: {{ .Values.postgres.service.port | quote }}
            - name: POSTGRES_DB
              value: {{ .Values.postgres.database | quote }}
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: {{ include "openrun.postgresAppSecretName" . }}
                  key: {{ .Values.postgres.appUser.usernameKey }}
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "openrun.postgresAppSecretName" . }}
                  key: {{ .Values.postgres.appUser.passwordKey }}
            {{- else if .Values.externalDatabase.enabled }}
            - name: POSTGRES_HOST
              value: {{ required "externalDatabase.host is required" .Values.externalDatabase.host | quote }}
            - name: POSTGRES_PORT
              value: {{ .Values.externalDatabase.port | default 5432 | quote }}
            - name: POSTGRES_DB
              value: {{ required "externalDatabase.database is required" .Values.externalDatabase.database | quote }}
            {{- if .Values.externalDatabase.existingSecretName }}
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.externalDatabase.existingSecretName }}
                  key: {{ .Values.externalDatabase.usernameKey | default "username" }}
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.externalDatabase.existingSecretName }}
                  key: {{ .Values.externalDatabase.passwordKey | default "password" }}
            {{- else }}
            - name: POSTGRES_USER
              value: {{ required "externalDatabase.username is required" .Values.externalDatabase.username | quote }}
            - name: POSTGRES_PASSWORD
              value: {{ required "externalDatabase.password is required" .Values.externalDatabase.password | quote }}
            {{- end }}
            {{- end }}
            - name: POSTGRES_AUDIT_DB
              value: {{ default "openrun_audit" .Values.config.metadata.auditDatabase | quote }}
      containers:
        - name: openrun
          {{- $tag := default .Chart.AppVersion .Values.image.tag }}
          image: "{{ .Values.image.repository }}:{{ $tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - name: http
              containerPort: {{ .Values.config.http.port }}
{{ if .Values.config.https.enabled }}
            - name: https
              containerPort: {{ .Values.config.https.port }}
{{ end }}
{{ if .Values.livenessProbe.enabled }}
          livenessProbe:
            httpGet:
              path: {{ $healthCheckPath }}
              port: http
            initialDelaySeconds: {{ .Values.livenessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.livenessProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.livenessProbe.timeoutSeconds }}
            failureThreshold: {{ .Values.livenessProbe.failureThreshold }}
{{ end }}
{{ if .Values.readinessProbe.enabled }}
          readinessProbe:
            httpGet:
              path: {{ $healthCheckPath }}
              port: http
            initialDelaySeconds: {{ .Values.readinessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.readinessProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.readinessProbe.timeoutSeconds }}
            failureThreshold: {{ .Values.readinessProbe.failureThreshold }}
{{ end }}
          volumeMounts:
            - name: config
              mountPath: {{ $configFile }}
              subPath: openrun.toml
      volumes:
        - name: config
          secret:
            secretName: {{ include "openrun.configSecretName" . }}
