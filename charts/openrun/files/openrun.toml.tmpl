# Generated by the OpenRun Helm chart. Changes will be overwritten on upgrade.
{{- if and (not .Values.registry2.enabled) (not .Values.config.registry.url) }}
{{- fail "config.registry.url must be provided when registry2.enabled is false" }}
{{- end }}
{{- if .Values.config.serverUri }}
server_uri = "{{ .Values.config.serverUri }}"
{{- end }}
admin_user = "{{ .Values.config.adminUser }}"

[logging]
level = "{{ .Values.config.logging.level }}"
{{- if .Values.config.logging.console }}
console = true
{{- end }}
file = {{ .Values.config.logging.file }}
access_logging = {{ .Values.config.logging.access_logging }}

[http]
host = "{{ .Values.config.http.host }}"
port = {{ .Values.config.http.port }}
redirect_to_https = {{ .Values.config.http.redirectToHttps }}

[https]
host = "{{ .Values.config.https.host }}"
port = {{ .Values.config.https.port }}
service_email = "{{ .Values.config.https.serviceEmail }}"
use_staging = {{ .Values.config.https.useStaging }}

[security]
{{- with .Values.config.security.appDefaultAuthType }}
app_default_auth_type = "{{ . }}"
{{- end }}
{{- with .Values.config.security.adminPasswordBcrypt }}
admin_password_bcrypt = "{{ . }}"
{{- end }}
{{- with .Values.config.security.sessionSecret }}
session_secret = "{{ . }}"
{{- end }}
{{- with .Values.config.security.sessionBlockKey }}
session_block_key = "{{ . }}"
{{- end }}
{{- with .Values.config.security.defaultSecretsProvider }}
default_secrets_provider = "{{ . }}"
{{- end }}

[metadata]
{{- $metadataDb := include "openrun.databaseConnectionFor" (dict "context" . "database" (default "openrun" .Values.config.metadata.database)) }}
{{- $auditDb := include "openrun.databaseConnectionFor" (dict "context" . "database" (default "openrun_audit" .Values.config.metadata.auditDatabase)) }}
db_connection = "{{ $metadataDb }}"
audit_db_connection = "{{ $auditDb }}"

[system]
container_command = "kubernetes"
{{- $ns := default .Release.Namespace .Values.config.kubernetes.namespace }}
{{- $defaultDomain := .Values.config.system.defaultDomain }}
{{- if not $defaultDomain }}
{{- $defaultDomain = printf "openrun.%s.svc.cluster.local" $ns }}
{{- end }}
default_domain = "{{ $defaultDomain }}"

[kubernetes]
namespace = "{{ default .Release.Namespace .Values.config.kubernetes.namespace }}"

[registry]
{{- $registryUrl := include "openrun.registryUrl" . }}
url = "{{ $registryUrl }}"
{{- with .Values.config.registry.project }}
project = "{{ . }}"
{{- end }}
{{- $registryInsecure := ternary true .Values.config.registry.insecure (and .Values.registry2.enabled (not .Values.config.registry.insecure)) }}
insecure = {{ $registryInsecure }}
{{- with .Values.config.registry.type }}
type = "{{ . }}"
{{- end }}
{{- with .Values.config.registry.awsRegion }}
aws_region = "{{ . }}"
{{- end }}
{{- $registryUsername := .Values.config.registry.username | default (ternary .Values.registry2.auth.username "" (and .Values.registry2.enabled .Values.registry2.auth.enabled)) }}
{{- if $registryUsername }}
username = "{{ $registryUsername }}"
{{- end }}
{{- $registryPassword := .Values.config.registry.password | default (ternary .Values.registry2.auth.password "" (and .Values.registry2.enabled .Values.registry2.auth.enabled)) }}
{{- if $registryPassword }}
password = "{{ $registryPassword }}"
{{- end }}
